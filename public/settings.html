<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CUA Settings</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="page">
      <header class="topbar">
        <a class="brand" href="/">
          <img src="/assets/cua-logo.png" alt="CUA Logo" />
        </a>
        <h1 class="app-brand-title">CUA Annahme</h1>
        <div class="topbar-actions">
          <button type="button" id="theme-toggle" class="theme-toggle">Light</button>
          <a class="btn-link" href="/">Zurück</a>
        </div>
      </header>

      <main class="panel">
        <h1 class="page-title">Einstellungen</h1>
        <p class="meta" id="meta">Mode: - | excelPath: -</p>

        <fieldset>
          <legend>Basis (Ebene 1)</legend>
          <div class="grid">
            <div>
              <label for="excel-path">excelPath</label>
              <input id="excel-path" type="text" />
            </div>

            <div>
              <label for="year-sheet-name">yearSheetName (leer = aktuelles Jahr)</label>
              <input id="year-sheet-name" type="text" />
            </div>

            <div>
              <label for="backup-policy">backupPolicy</label>
              <select id="backup-policy">
                <option value="daily">daily</option>
                <option value="interval">interval</option>
              </select>
            </div>

            <div>
              <label for="backup-interval">backupIntervalMinutes</label>
              <input id="backup-interval" type="number" min="1" step="1" />
            </div>

            <div>
              <label for="backup-retention">backupRetentionDays</label>
              <input id="backup-retention" type="number" min="0" step="1" />
            </div>

            <div>
              <label for="ui-default-eilig">uiDefaultEilig</label>
              <select id="ui-default-eilig">
                <option value="ja">ja</option>
                <option value="nein">nein</option>
              </select>
            </div>

            <div>
              <label>backupEnabled</label>
              <div class="check-row">
                <input id="backup-enabled" type="checkbox" />
                <span>aktiv</span>
              </div>
            </div>

            <div>
              <label>backupZip</label>
              <div class="check-row">
                <input id="backup-zip" type="checkbox" />
                <span>.zip statt .xlsx</span>
              </div>
            </div>

            <div>
              <label>uiShowPackagePreview</label>
              <div class="check-row">
                <input id="ui-show-package-preview" type="checkbox" />
                <span>Vorschau anzeigen</span>
              </div>
            </div>

            <div>
              <label for="ui-required-fields">uiRequiredFields (ein Feldpfad pro Zeile)</label>
              <textarea id="ui-required-fields" rows="8"></textarea>
            </div>

            <div>
              <label>uiRequireAtLeastOneSample</label>
              <div class="check-row">
                <input id="ui-require-at-least-one-sample" type="checkbox" />
                <span>Mindestens eine Probe empfehlen</span>
              </div>
            </div>

            <div>
              <label>uiWarnOnly</label>
              <div class="check-row">
                <input id="ui-warn-only" type="checkbox" />
                <span>Nur Warnung statt Hard-Block</span>
              </div>
            </div>

            <div>
              <label>uiBlockOnMissing</label>
              <div class="check-row">
                <input id="ui-block-on-missing" type="checkbox" />
                <span>Blockieren bei fehlenden wichtigen Feldern</span>
              </div>
            </div>

            <div>
              <label>Kürzel Presets</label>
              <div id="ui-kuerzel-preset-list" class="preset-list"></div>
              <div class="actions" style="margin-top: 0.45rem;">
                <input id="ui-kuerzel-preset-new" type="text" placeholder="Neues Kürzel" />
                <button id="ui-kuerzel-preset-add" type="button" class="secondary">Hinzufügen</button>
              </div>
            </div>

            <div>
              <label for="quick-container-plastic">Quick Buttons Kunststoff (eine Option pro Zeile)</label>
              <textarea id="quick-container-plastic" rows="8"></textarea>
            </div>

            <div>
              <label for="quick-container-glass">Quick Buttons Glas (eine Option pro Zeile)</label>
              <textarea id="quick-container-glass" rows="8"></textarea>
            </div>
          </div>

          <div class="actions" style="margin-top: 0.8rem;">
            <button id="save-basic" type="button" class="primary">Basis speichern</button>
            <button id="validate-path" type="button" class="secondary">Pfad prüfen</button>
            <button id="reset-cache" type="button" class="secondary">Cache zurücksetzen</button>
          </div>
        </fieldset>

        <fieldset>
          <legend>Advanced (Ebene 2)</legend>
          <div class="grid">
            <div>
              <label for="mode">mode</label>
              <select id="mode">
                <option value="single">single</option>
                <option value="writer">writer</option>
                <option value="client">client</option>
              </select>
            </div>

            <div>
              <label for="writer-host">writerHost</label>
              <input id="writer-host" type="text" />
            </div>

            <div>
              <label for="writer-backend">writerBackend</label>
              <select id="writer-backend">
                <option value="com">com</option>
                <option value="exceljs">exceljs</option>
              </select>
            </div>

            <div>
              <label for="writer-token">writerToken</label>
              <input id="writer-token" type="password" autocomplete="off" />
            </div>

            <div>
              <label for="admin-key">Admin Key (nur für Ebene 2)</label>
              <input id="admin-key" type="password" autocomplete="off" />
            </div>
          </div>

          <div class="actions" style="margin-top: 0.8rem;">
            <button id="save-advanced" type="button" class="primary">Advanced speichern</button>
          </div>
        </fieldset>

        <fieldset>
          <legend>Pakete</legend>
          <div class="actions">
            <a class="btn-link" href="/packages">Pakete verwalten</a>
          </div>
          <p class="meta" id="packages-summary">Pakete geladen: -</p>
        </fieldset>

        <pre id="status" class="result-box"></pre>
        <pre id="validate-result" class="result-box"></pre>
      </main>
    </div>

    <div id="toast-container" class="toast-wrap"></div>

    <script>
      const THEME_KEY = 'cua-theme';
      const themeToggle = document.getElementById('theme-toggle');
      function applyTheme(theme) {
        const resolved = theme === 'light' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', resolved);
        localStorage.setItem(THEME_KEY, resolved);
        themeToggle.textContent = resolved === 'dark' ? 'Light' : 'Dark';
      }
      applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
      themeToggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme') || 'dark';
        applyTheme(current === 'dark' ? 'light' : 'dark');
      });

      const toastContainer = document.getElementById('toast-container');
      function showToast(type, message) {
        const el = document.createElement('div');
        el.className = `toast ${type || 'info'}`;
        el.textContent = message;
        toastContainer.appendChild(el);
        setTimeout(() => el.remove(), 4200);
      }

      const meta = document.getElementById('meta');
      const packagesSummary = document.getElementById('packages-summary');
      const status = document.getElementById('status');
      const validateResult = document.getElementById('validate-result');

      const excelPathInput = document.getElementById('excel-path');
      const yearSheetNameInput = document.getElementById('year-sheet-name');
      const backupEnabledInput = document.getElementById('backup-enabled');
      const backupPolicyInput = document.getElementById('backup-policy');
      const backupIntervalInput = document.getElementById('backup-interval');
      const backupRetentionInput = document.getElementById('backup-retention');
      const backupZipInput = document.getElementById('backup-zip');
      const uiShowPackagePreviewInput = document.getElementById('ui-show-package-preview');
      const uiKuerzelPresetList = document.getElementById('ui-kuerzel-preset-list');
      const uiKuerzelPresetNewInput = document.getElementById('ui-kuerzel-preset-new');
      const uiKuerzelPresetAddButton = document.getElementById('ui-kuerzel-preset-add');
      const uiRequiredFieldsInput = document.getElementById('ui-required-fields');
      const uiRequireAtLeastOneSampleInput = document.getElementById('ui-require-at-least-one-sample');
      const uiWarnOnlyInput = document.getElementById('ui-warn-only');
      const uiBlockOnMissingInput = document.getElementById('ui-block-on-missing');
      const uiDefaultEiligInput = document.getElementById('ui-default-eilig');
      const quickContainerPlasticInput = document.getElementById('quick-container-plastic');
      const quickContainerGlassInput = document.getElementById('quick-container-glass');

      const modeInput = document.getElementById('mode');
      const writerHostInput = document.getElementById('writer-host');
      const writerBackendInput = document.getElementById('writer-backend');
      const writerTokenInput = document.getElementById('writer-token');
      const adminKeyInput = document.getElementById('admin-key');

      const saveBasicButton = document.getElementById('save-basic');
      const saveAdvancedButton = document.getElementById('save-advanced');
      const validatePathButton = document.getElementById('validate-path');
      const resetCacheButton = document.getElementById('reset-cache');

      let currentConfig = null;
      let kuerzelPresets = ['AD', 'DV', 'LB', 'DH', 'SE', 'JO', 'RS', 'KH'];

      function setStatus(payload) {
        status.textContent = JSON.stringify(payload, null, 2);
      }

      function setValidateResult(payload) {
        validateResult.textContent = JSON.stringify(payload, null, 2);
      }

      function fillForm(config) {
        currentConfig = config;
        meta.textContent = `Mode: ${config.mode} | excelPath: ${config.excelPath}`;

        excelPathInput.value = config.excelPath || '';
        yearSheetNameInput.value = config.yearSheetName || '';
        backupEnabledInput.checked = Boolean(config.backupEnabled);
        backupPolicyInput.value = config.backupPolicy || 'daily';
        backupIntervalInput.value = config.backupIntervalMinutes ?? 60;
        backupRetentionInput.value = config.backupRetentionDays ?? 14;
        backupZipInput.checked = Boolean(config.backupZip);
        uiShowPackagePreviewInput.checked = Boolean(config.uiShowPackagePreview);
        kuerzelPresets = normalizeKuerzelPresetList(config.uiKuerzelPreset);
        if (kuerzelPresets.length === 0) {
          kuerzelPresets = ['AD', 'DV', 'LB', 'DH', 'SE', 'JO', 'RS', 'KH'];
        }
        renderKuerzelPresetList();
        uiRequiredFieldsInput.value = Array.isArray(config.uiRequiredFields) ? config.uiRequiredFields.join('\n') : '';
        uiRequireAtLeastOneSampleInput.checked = config.uiRequireAtLeastOneSample !== false;
        uiWarnOnlyInput.checked = config.uiWarnOnly !== false;
        uiBlockOnMissingInput.checked = Boolean(config.uiBlockOnMissing);
        uiDefaultEiligInput.value = config.uiDefaultEilig || 'ja';
        quickContainerPlasticInput.value = Array.isArray(config.quickContainerPlastic) ? config.quickContainerPlastic.join('\n') : '';
        quickContainerGlassInput.value = Array.isArray(config.quickContainerGlass) ? config.quickContainerGlass.join('\n') : '';

        modeInput.value = config.mode || 'single';
        writerHostInput.value = config.writerHost || '';
        writerBackendInput.value = config.writerBackend || 'com';
      }

      async function loadConfig() {
        const response = await fetch('/api/config');
        const data = await response.json();
        if (!response.ok || !data.ok) {
          throw new Error(data.message || 'Config konnte nicht geladen werden');
        }
        fillForm(data.config);
      }

      async function loadPackagesSummary() {
        const response = await fetch('/api/packages', { cache: 'no-store' });
        const data = await response.json();
        if (!response.ok || !Array.isArray(data)) {
          throw new Error(data.message || 'Pakete konnten nicht geladen werden');
        }
        packagesSummary.textContent = `Pakete geladen: ${data.length}`;
      }

      async function saveConfig(payload, adminKey = '') {
        const headers = { 'Content-Type': 'application/json' };
        if (adminKey) headers['x-admin-key'] = adminKey;

        const response = await fetch('/api/config', {
          method: 'POST',
          headers,
          body: JSON.stringify(payload),
        });

        const data = await response.json();
        setStatus(data);
        if (response.ok && data.ok) {
          fillForm(data.config);
          showToast('success', 'Einstellungen gespeichert');
        } else {
          showToast('error', data.message || 'Speichern fehlgeschlagen');
        }
      }

      function parseMultilineList(value) {
        const seen = new Set();
        const items = [];
        String(value || '').split(/\r?\n/).forEach((line) => {
          const normalized = line.trim().replace(/\s+/g, ' ');
          if (!normalized || seen.has(normalized)) return;
          seen.add(normalized);
          items.push(normalized);
        });
        return items;
      }

      function normalizeKuerzelPresetValue(value) {
        return String(value || '').trim().replace(/\s+/g, ' ').toUpperCase();
      }

      function normalizeKuerzelPresetList(values) {
        const seen = new Set();
        const result = [];
        (Array.isArray(values) ? values : []).forEach((item) => {
          const normalized = normalizeKuerzelPresetValue(item);
          if (!normalized || seen.has(normalized)) return;
          seen.add(normalized);
          result.push(normalized);
        });
        return result;
      }

      function renderKuerzelPresetList() {
        uiKuerzelPresetList.innerHTML = '';
        kuerzelPresets.forEach((preset) => {
          const row = document.createElement('div');
          row.className = 'preset-item';
          const label = document.createElement('span');
          label.textContent = preset;
          const removeButton = document.createElement('button');
          removeButton.type = 'button';
          removeButton.className = 'secondary danger';
          removeButton.textContent = 'Löschen';
          removeButton.addEventListener('click', () => {
            kuerzelPresets = kuerzelPresets.filter((item) => item !== preset);
            renderKuerzelPresetList();
          });
          row.appendChild(label);
          row.appendChild(removeButton);
          uiKuerzelPresetList.appendChild(row);
        });
      }

      saveBasicButton.addEventListener('click', async () => {
        try {
          await saveConfig({
            excelPath: excelPathInput.value.trim(),
            yearSheetName: yearSheetNameInput.value.trim(),
            backupEnabled: backupEnabledInput.checked,
            backupPolicy: backupPolicyInput.value,
            backupIntervalMinutes: Number(backupIntervalInput.value),
            backupRetentionDays: Number(backupRetentionInput.value),
            backupZip: backupZipInput.checked,
            uiShowPackagePreview: uiShowPackagePreviewInput.checked,
            uiKuerzelPreset: normalizeKuerzelPresetList(kuerzelPresets),
            uiRequiredFields: parseMultilineList(uiRequiredFieldsInput.value),
            uiRequireAtLeastOneSample: uiRequireAtLeastOneSampleInput.checked,
            uiWarnOnly: uiWarnOnlyInput.checked,
            uiBlockOnMissing: uiBlockOnMissingInput.checked,
            uiDefaultEilig: uiDefaultEiligInput.value,
            quickContainerPlastic: parseMultilineList(quickContainerPlasticInput.value),
            quickContainerGlass: parseMultilineList(quickContainerGlassInput.value),
          });
        } catch (error) {
          setStatus({ ok: false, message: error.message });
          showToast('error', error.message);
        }
      });

      uiKuerzelPresetAddButton.addEventListener('click', () => {
        const next = normalizeKuerzelPresetValue(uiKuerzelPresetNewInput.value);
        if (!next) return;
        if (!kuerzelPresets.includes(next)) {
          kuerzelPresets.push(next);
          kuerzelPresets = normalizeKuerzelPresetList(kuerzelPresets);
          renderKuerzelPresetList();
        }
        uiKuerzelPresetNewInput.value = '';
        uiKuerzelPresetNewInput.focus();
      });
      uiKuerzelPresetNewInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          uiKuerzelPresetAddButton.click();
        }
      });

      saveAdvancedButton.addEventListener('click', async () => {
        try {
          await saveConfig(
            {
              mode: modeInput.value,
              writerHost: writerHostInput.value.trim(),
              writerBackend: writerBackendInput.value,
              writerToken: writerTokenInput.value,
            },
            adminKeyInput.value,
          );
        } catch (error) {
          setStatus({ ok: false, message: error.message });
          showToast('error', error.message);
        }
      });

      validatePathButton.addEventListener('click', async () => {
        try {
          const excelPath = excelPathInput.value.trim();
          const query = new URLSearchParams({ excelPath }).toString();
          const response = await fetch(`/api/config/validate?${query}`);
          const data = await response.json();
          setValidateResult(data);
          showToast(response.ok ? 'success' : 'error', response.ok ? 'Pfad geprüft' : 'Pfadprüfung fehlgeschlagen');
        } catch (error) {
          setValidateResult({ ok: false, message: error.message });
          showToast('error', error.message);
        }
      });

      resetCacheButton.addEventListener('click', async () => {
        try {
          const response = await fetch('/api/state/reset', { method: 'POST' });
          const data = await response.json();
          setStatus(data);
          showToast(response.ok ? 'success' : 'error', response.ok ? 'Cache zurückgesetzt' : (data.message || 'Cache reset fehlgeschlagen'));
        } catch (error) {
          setStatus({ ok: false, message: error.message });
          showToast('error', error.message);
        }
      });

      Promise.all([loadConfig(), loadPackagesSummary()])
        .then(() => {
          setStatus({ ok: true, message: 'Settings geladen' });
          showToast('success', 'Settings geladen');
        })
        .catch((error) => {
          setStatus({ ok: false, message: error.message });
          showToast('error', error.message);
        });
    </script>
  </body>
</html>
