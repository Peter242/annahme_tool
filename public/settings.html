<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Einstellungen</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/settings/common.css" />
  </head>
  <body>
    <div class="settings-shell">
      <header class="topbar">
        <a class="brand" href="/">
          <img src="/assets/cua-logo.png" alt="CUA Logo" />
        </a>
        <h1 class="app-brand-title">Einstellungen</h1>
        <div class="topbar-actions">
          <button type="button" id="theme-toggle" class="theme-toggle">Light</button>
          <a class="btn-link" href="/">Zurück</a>
        </div>
      </header>

      <div class="settings-layout">
        <aside class="settings-nav">
          <button type="button" class="is-active" data-target="allgemein">Allgemein</button>
          <button type="button" data-target="workflow">Workflow</button>
          <button type="button" data-target="backups">Backups</button>
          <button type="button" data-target="listen">Listen & Vorlagen</button>
        </aside>

        <main class="settings-content">
          <section id="allgemein" class="settings-section is-active">
            <h2>Allgemein</h2>
            <p class="settings-note">Hier stellst du Pfad und Basisverhalten der Excel-Anbindung ein.</p>

            <div class="settings-grid">
              <div class="settings-row-full">
                <label for="excel-path">Excel-Datei</label>
                <div class="action-row" style="margin-top:0;">
                  <input id="excel-path" type="text" placeholder="z. B. C:\Annahme\Annahme.xlsx" />
                  <button type="button" id="pick-file" class="secondary">Datei auswählen</button>
                  <input id="pick-file-input" type="file" accept=".xlsx,.xlsm,.xls" class="hidden" />
                </div>
                <div class="field-help">Die API erwartet einen serverseitigen Pfad. Der Dateiname aus dem Dialog kann als Hilfe übernommen werden.</div>
                <div id="excel-path-msg" class="inline-error hidden"></div>
              </div>

              <div>
                <label for="year-sheet-name">Jahresblatt (optional)</label>
                <input id="year-sheet-name" type="text" placeholder="leer = aktuelles Jahr" />
                <div class="field-help">Wenn leer, wird automatisch das Blatt für das aktuelle Jahr verwendet.</div>
              </div>

              <div>
                <label>Writer Backend</label>
                <div id="writer-backend" class="readonly-chip">-</div>
                <div class="action-row">
                  <a class="btn-link" href="/settings/advanced">Advanced öffnen</a>
                </div>
              </div>

              <div class="settings-row-full">
                <label>Pfad prüfen</label>
                <div class="action-row" style="margin-top:0;">
                  <button type="button" id="validate-path" class="secondary">Pfad prüfen</button>
                </div>
                <div id="validate-msg" class="inline-ok hidden"></div>
              </div>

              <div class="settings-row-full">
                <label>Cache zurücksetzen</label>
                <div class="field-help">Löscht nur den Laufzeit-Cache. Die eigentliche Excel-Datei bleibt unverändert.</div>
                <div class="action-row" style="margin-top:0.5rem;">
                  <button type="button" id="reset-cache" class="secondary">Cache zurücksetzen</button>
                </div>
                <div id="cache-msg" class="inline-ok hidden"></div>
              </div>
            </div>

            <div class="action-row">
              <button type="button" id="save-allgemein" class="primary">Änderungen speichern</button>
            </div>
          </section>

          <section id="workflow" class="settings-section">
            <h2>Workflow</h2>
            <p class="settings-note">Steuert, wie strikt die Eingabeoberfläche bei der Auftragserfassung arbeitet.</p>

            <div class="settings-grid">
              <div class="settings-row-full">
                <label for="ui-default-eilig">Eilig-Default</label>
                <select id="ui-default-eilig">
                  <option value="ja">Ja (Standard)</option>
                  <option value="nein">Nein (Standard)</option>
                </select>
              </div>

              <div class="settings-row-full">
                <div class="toggle-row">
                  <label class="switch">
                    <input id="ui-warn-only" type="checkbox" />
                    <span class="slider"></span>
                  </label>
                  <div>
                    <div class="toggle-label">Warnungen statt Blockieren</div>
                    <div class="toggle-desc">Fehlende Pflichtangaben werden als Hinweis angezeigt.</div>
                  </div>
                </div>
              </div>

              <div class="settings-row-full">
                <div class="toggle-row">
                  <label class="switch">
                    <input id="ui-block-on-missing" type="checkbox" />
                    <span class="slider"></span>
                  </label>
                  <div>
                    <div class="toggle-label">Bei fehlenden Feldern blockieren</div>
                    <div class="toggle-desc">Commit wird verhindert, bis wichtige Felder gepflegt sind.</div>
                  </div>
                </div>
              </div>

              <div class="settings-row-full">
                <div class="toggle-row">
                  <label class="switch">
                    <input id="ui-require-at-least-one-sample" type="checkbox" />
                    <span class="slider"></span>
                  </label>
                  <div>
                    <div class="toggle-label">Mindestens eine Probe empfehlen</div>
                    <div class="toggle-desc">Zeigt Hinweis, wenn ein Auftrag ohne Probe erstellt wird.</div>
                  </div>
                </div>
              </div>

              <div class="settings-row-full">
                <div class="toggle-row">
                  <label class="switch">
                    <input id="excel-write-address-block" type="checkbox" />
                    <span class="slider"></span>
                  </label>
                  <div>
                    <div class="toggle-label">Anschrift in Excel übertragen</div>
                    <div class="toggle-desc">Schreibt den Anschrift-Block in Kopfspalte J.</div>
                  </div>
                </div>
              </div>

              <div class="settings-row-full">
                <div class="toggle-row">
                  <label class="switch">
                    <input id="ui-show-package-preview" type="checkbox" />
                    <span class="slider"></span>
                  </label>
                  <div>
                    <div class="toggle-label">Paketvorschau anzeigen</div>
                    <div class="toggle-desc">Blendet Pakettexte direkt in der Erfassungsoberfläche ein.</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="action-row">
              <button type="button" id="save-workflow" class="primary">Änderungen speichern</button>
            </div>
          </section>

          <section id="backups" class="settings-section">
            <h2>Backups</h2>
            <p class="settings-note">Definiert, wann Sicherungen erstellt und wie lange sie aufbewahrt werden.</p>

            <div class="settings-grid">
              <div class="settings-row-full">
                <div class="toggle-row">
                  <label class="switch">
                    <input id="backup-enabled" type="checkbox" />
                    <span class="slider"></span>
                  </label>
                  <div>
                    <div class="toggle-label">Backups aktiv</div>
                    <div class="toggle-desc">Erstellt Sicherungen vor dem Commit.</div>
                  </div>
                </div>
              </div>

              <div>
                <label for="backup-policy">Backup-Intervall</label>
                <select id="backup-policy">
                  <option value="daily">Täglich</option>
                  <option value="interval">Alle X Minuten</option>
                </select>
              </div>

              <div id="backup-interval-wrap">
                <label for="backup-interval">Intervall in Minuten</label>
                <input id="backup-interval" type="number" min="1" step="1" />
              </div>

              <div>
                <label for="backup-retention">Aufbewahrung (Tage)</label>
                <input id="backup-retention" type="number" min="0" step="1" />
              </div>

              <div>
                <div class="toggle-row">
                  <label class="switch">
                    <input id="backup-zip" type="checkbox" />
                    <span class="slider"></span>
                  </label>
                  <div>
                    <div class="toggle-label">ZIP-Backups</div>
                    <div class="toggle-desc">Speichert Sicherungen als ZIP statt XLSX.</div>
                  </div>
                </div>
              </div>

              <div class="settings-row-full">
                <label for="backup-dir">Backup-Ordner</label>
                <input id="backup-dir" type="text" placeholder="./backups oder C:\Annahme\Backups" />
                <div class="field-help">Relative Pfade sind relativ zum Projektordner, absolute Pfade werden direkt genutzt.</div>
              </div>
            </div>

            <div class="action-row">
              <button type="button" id="create-backup-now" class="primary">Backup jetzt erstellen</button>
              <button type="button" id="pick-backup-dir">Ordner wählen...</button>
              <button type="button" id="validate-backup-dir">Pfad prüfen</button>
              <button type="button" id="save-backups">Änderungen speichern</button>
            </div>
            <div class="field-help">Manuelle Backups sind auch möglich, wenn automatische Backups deaktiviert sind.</div>
            <div id="backup-dir-msg" class="inline-error hidden"></div>
            <div id="manual-backup-msg" class="inline-ok hidden"></div>
          </section>

          <section id="listen" class="settings-section">
            <h2>Listen & Vorlagen</h2>
            <p class="settings-note">Diese Bereiche werden in separaten Seiten gepflegt, damit die Hauptseite übersichtlich bleibt.</p>
            <div class="list-links">
              <a class="link-card" href="/single-parameters">
                <strong>Einzelparameter verwalten</strong>
                <span>Katalogpflege für Einzelparameter (Name, Kürzel, Labore, Medien, Funktion, PV-Flag).</span>
              </a>
              <a class="link-card" href="/settings/kuerzel">
                <strong>Kürzel Presets verwalten</strong>
                <span>Chips hinzufügen, löschen und speichern</span>
              </a>
              <a class="link-card" href="/settings/gebinde/plastik">
                <strong>Gebinde Quick Buttons Kunststoff</strong>
                <span>Sortierbare Liste mit Add/Remove/Move</span>
              </a>
              <a class="link-card" href="/settings/gebinde/glas">
                <strong>Gebinde Quick Buttons Glas</strong>
                <span>Sortierbare Liste mit Add/Remove/Move</span>
              </a>
              <a class="link-card" href="/settings/required">
                <strong>Required Fields</strong>
                <span>Freundliche Checkliste statt Feldpfade</span>
              </a>
              <a class="link-card" href="/packages">
                <strong>Pakete verwalten</strong>
                <span>Öffnet die bestehende Paketverwaltung</span>
              </a>
            </div>
          </section>
        </main>
      </div>
    </div>

    <div id="toast-container" class="toast-wrap"></div>

    <script src="/settings/common.js"></script>
    <script>
      initThemeToggle('theme-toggle');

      const navButtons = Array.from(document.querySelectorAll('.settings-nav button[data-target]'));
      const sections = Array.from(document.querySelectorAll('.settings-section'));

      const state = {};

      const excelPathInput = document.getElementById('excel-path');
      const pickFileButton = document.getElementById('pick-file');
      const pickFileInput = document.getElementById('pick-file-input');
      const yearSheetNameInput = document.getElementById('year-sheet-name');
      const writerBackendValue = document.getElementById('writer-backend');
      const validatePathButton = document.getElementById('validate-path');
      const validateMsg = document.getElementById('validate-msg');
      const excelPathMsg = document.getElementById('excel-path-msg');
      const resetCacheButton = document.getElementById('reset-cache');
      const cacheMsg = document.getElementById('cache-msg');

      const uiDefaultEiligInput = document.getElementById('ui-default-eilig');
      const uiWarnOnlyInput = document.getElementById('ui-warn-only');
      const uiBlockOnMissingInput = document.getElementById('ui-block-on-missing');
      const uiRequireAtLeastOneSampleInput = document.getElementById('ui-require-at-least-one-sample');
      const excelWriteAddressBlockInput = document.getElementById('excel-write-address-block');
      const uiShowPackagePreviewInput = document.getElementById('ui-show-package-preview');

      const backupEnabledInput = document.getElementById('backup-enabled');
      const backupPolicyInput = document.getElementById('backup-policy');
      const backupIntervalWrap = document.getElementById('backup-interval-wrap');
      const backupIntervalInput = document.getElementById('backup-interval');
      const backupRetentionInput = document.getElementById('backup-retention');
      const backupZipInput = document.getElementById('backup-zip');
      const backupDirInput = document.getElementById('backup-dir');
      const pickBackupDirButton = document.getElementById('pick-backup-dir');
      const validateBackupDirButton = document.getElementById('validate-backup-dir');
      const createBackupNowButton = document.getElementById('create-backup-now');
      const backupDirMsg = document.getElementById('backup-dir-msg');
      const manualBackupMsg = document.getElementById('manual-backup-msg');

      function showSection(target) {
        navButtons.forEach((button) => {
          button.classList.toggle('is-active', button.dataset.target === target);
        });
        sections.forEach((section) => {
          section.classList.toggle('is-active', section.id === target);
        });
      }

      navButtons.forEach((button) => {
        button.addEventListener('click', () => showSection(button.dataset.target));
      });

      function renderFromState() {
        excelPathInput.value = state.excelPath || '';
        yearSheetNameInput.value = state.yearSheetName || '';
        writerBackendValue.textContent = state.writerBackend || '-';

        uiDefaultEiligInput.value = state.uiDefaultEilig || 'ja';
        uiWarnOnlyInput.checked = state.uiWarnOnly !== false;
        uiBlockOnMissingInput.checked = Boolean(state.uiBlockOnMissing);
        uiRequireAtLeastOneSampleInput.checked = state.uiRequireAtLeastOneSample !== false;
        excelWriteAddressBlockInput.checked = state.excelWriteAddressBlock !== false;
        uiShowPackagePreviewInput.checked = Boolean(state.uiShowPackagePreview);

        backupEnabledInput.checked = Boolean(state.backupEnabled);
        backupPolicyInput.value = state.backupPolicy || 'daily';
        backupIntervalInput.value = Number(state.backupIntervalMinutes || 60);
        backupRetentionInput.value = Number(state.backupRetentionDays || 14);
        backupZipInput.checked = Boolean(state.backupZip);
        backupDirInput.value = state.backupDir || './backups';
        backupIntervalWrap.classList.toggle('hidden', backupPolicyInput.value !== 'interval');
      }

      function clearMessages() {
        [validateMsg, excelPathMsg, cacheMsg, backupDirMsg, manualBackupMsg].forEach((el) => {
          el.classList.add('hidden');
          el.textContent = '';
          el.classList.remove('inline-error', 'inline-ok');
        });
      }

      function updateStateFromGeneral() {
        state.excelPath = String(excelPathInput.value || '').trim();
        state.yearSheetName = String(yearSheetNameInput.value || '').trim();
      }

      function updateStateFromWorkflow() {
        state.uiDefaultEilig = uiDefaultEiligInput.value;
        state.uiWarnOnly = uiWarnOnlyInput.checked;
        state.uiBlockOnMissing = uiBlockOnMissingInput.checked;
        state.uiRequireAtLeastOneSample = uiRequireAtLeastOneSampleInput.checked;
        state.excelWriteAddressBlock = excelWriteAddressBlockInput.checked;
        state.uiShowPackagePreview = uiShowPackagePreviewInput.checked;
      }

      function updateStateFromBackups() {
        state.backupEnabled = backupEnabledInput.checked;
        state.backupPolicy = backupPolicyInput.value;
        state.backupIntervalMinutes = Number(backupIntervalInput.value);
        state.backupRetentionDays = Number(backupRetentionInput.value);
        state.backupZip = backupZipInput.checked;
        state.backupDir = String(backupDirInput.value || '').trim();
      }

      function mergeAndRender(config) {
        Object.assign(state, config);
        renderFromState();
      }

      pickFileButton.addEventListener('click', () => pickFileInput.click());
      pickFileInput.addEventListener('change', () => {
        const file = pickFileInput.files && pickFileInput.files[0];
        if (!file) return;
        const current = String(excelPathInput.value || '');
        const pieces = current.split(/[\\/]/);
        if (pieces.length > 1) {
          pieces[pieces.length - 1] = file.name;
          excelPathInput.value = pieces.join(current.includes('\\') ? '\\' : '/');
        } else {
          excelPathInput.value = file.name;
        }
      });

      backupPolicyInput.addEventListener('change', () => {
        backupIntervalWrap.classList.toggle('hidden', backupPolicyInput.value !== 'interval');
      });

      pickBackupDirButton.addEventListener('click', async () => {
        const originalText = pickBackupDirButton.textContent;
        pickBackupDirButton.disabled = true;
        pickBackupDirButton.textContent = 'Wähle Ordner...';
        backupDirMsg.classList.add('hidden');
        manualBackupMsg.classList.add('hidden');
        try {
          const result = await pickBackupDirNative();
          if (result.canceled) {
            return;
          }
          if (!result.selectedPath) {
            throw new Error('Es wurde kein Ordnerpfad zurückgegeben.');
          }
          backupDirInput.value = result.selectedPath;
          state.backupDir = result.selectedPath;
          const config = await saveConfig({ backupDir: result.selectedPath });
          mergeAndRender(config);
          backupDirMsg.textContent = `Pfad gesetzt: ${result.selectedPath}`;
          backupDirMsg.classList.remove('hidden', 'inline-error');
          backupDirMsg.classList.add('inline-ok');
          showToast('success', 'Backup-Ordner übernommen und gespeichert');
        } catch (error) {
          backupDirMsg.textContent = error.message;
          backupDirMsg.classList.remove('hidden', 'inline-ok');
          backupDirMsg.classList.add('inline-error');
          showToast('error', error.message);
        } finally {
          pickBackupDirButton.disabled = false;
          pickBackupDirButton.textContent = originalText;
        }
      });

      document.getElementById('save-allgemein').addEventListener('click', async () => {
        clearMessages();
        updateStateFromGeneral();
        if (!state.excelPath) {
          excelPathMsg.textContent = 'Bitte einen Excel-Pfad eingeben.';
          excelPathMsg.classList.remove('hidden');
          return;
        }
        try {
          const config = await saveConfig({
            excelPath: state.excelPath,
            yearSheetName: state.yearSheetName,
          });
          mergeAndRender(config);
          showToast('success', 'Gespeichert');
        } catch (error) {
          excelPathMsg.textContent = error.message;
          excelPathMsg.classList.remove('hidden');
          showToast('error', error.message);
        }
      });

      document.getElementById('save-workflow').addEventListener('click', async () => {
        updateStateFromWorkflow();
        try {
          const config = await saveConfig({
            uiDefaultEilig: state.uiDefaultEilig,
            uiWarnOnly: state.uiWarnOnly,
            uiBlockOnMissing: state.uiBlockOnMissing,
            uiRequireAtLeastOneSample: state.uiRequireAtLeastOneSample,
            excelWriteAddressBlock: state.excelWriteAddressBlock,
            uiShowPackagePreview: state.uiShowPackagePreview,
          });
          mergeAndRender(config);
          showToast('success', 'Gespeichert');
        } catch (error) {
          showToast('error', error.message);
        }
      });

      document.getElementById('save-backups').addEventListener('click', async () => {
        updateStateFromBackups();
        if (state.backupPolicy === 'interval' && (!Number.isFinite(state.backupIntervalMinutes) || state.backupIntervalMinutes < 1)) {
          showToast('error', 'Bitte ein gültiges Intervall größer 0 Minuten eintragen.');
          return;
        }
        if (!Number.isFinite(state.backupRetentionDays) || state.backupRetentionDays < 0) {
          showToast('error', 'Aufbewahrungstage müssen 0 oder größer sein.');
          return;
        }
        if (!state.backupDir) {
          backupDirMsg.textContent = 'Bitte einen Backup-Ordner eintragen.';
          backupDirMsg.classList.remove('hidden');
          showToast('error', backupDirMsg.textContent);
          return;
        }
        try {
          const config = await saveConfig({
            backupEnabled: state.backupEnabled,
            backupPolicy: state.backupPolicy,
            backupIntervalMinutes: state.backupIntervalMinutes,
            backupRetentionDays: state.backupRetentionDays,
            backupZip: state.backupZip,
            backupDir: state.backupDir,
          });
          mergeAndRender(config);
          showToast('success', 'Gespeichert');
        } catch (error) {
          showToast('error', error.message);
        }
      });

      validateBackupDirButton.addEventListener('click', async () => {
        clearMessages();
        updateStateFromBackups();
        if (!state.backupDir) {
          backupDirMsg.textContent = 'Bitte zuerst einen Backup-Ordner eintragen.';
          backupDirMsg.classList.remove('hidden');
          backupDirMsg.classList.add('inline-error');
          return;
        }
        try {
          const result = await validateBackupDir(state.backupDir);
          backupDirMsg.textContent = result.message || `Pfad OK: ${result.absolutePath}`;
          backupDirMsg.classList.remove('hidden');
          backupDirMsg.classList.add(result.ok ? 'inline-ok' : 'inline-error');
          showToast(result.ok ? 'success' : 'error', backupDirMsg.textContent);
        } catch (error) {
          backupDirMsg.textContent = error.message;
          backupDirMsg.classList.remove('hidden');
          backupDirMsg.classList.add('inline-error');
          showToast('error', error.message);
        }
      });

      createBackupNowButton.addEventListener('click', async () => {
        const originalText = createBackupNowButton.textContent;
        createBackupNowButton.disabled = true;
        createBackupNowButton.textContent = 'Erstelle Backup...';
        backupDirMsg.classList.add('hidden');
        manualBackupMsg.classList.add('hidden');
        manualBackupMsg.classList.remove('inline-error');
        manualBackupMsg.classList.add('inline-ok');
        try {
          const result = await createManualBackup(true);
          manualBackupMsg.textContent = `Backup erstellt: ${result.fileName} (${result.absoluteBackupPath})`;
          manualBackupMsg.classList.remove('hidden');
          showToast('success', `Backup erstellt: ${result.fileName}`);
        } catch (error) {
          manualBackupMsg.textContent = error.message;
          manualBackupMsg.classList.remove('hidden');
          manualBackupMsg.classList.remove('inline-ok');
          manualBackupMsg.classList.add('inline-error');
          showToast('error', error.message);
        } finally {
          createBackupNowButton.disabled = false;
          createBackupNowButton.textContent = originalText;
        }
      });


      validatePathButton.addEventListener('click', async () => {
        clearMessages();
        updateStateFromGeneral();
        if (!state.excelPath) {
          excelPathMsg.textContent = 'Bitte zuerst einen Pfad eintragen.';
          excelPathMsg.classList.remove('hidden');
          return;
        }
        try {
          await validateExcelPath(state.excelPath);
          validateMsg.textContent = 'Pfad ist gültig und die Datei kann gelesen werden.';
          validateMsg.classList.remove('hidden');
          validateMsg.classList.add('inline-ok');
          showToast('success', 'Pfad geprüft');
        } catch (error) {
          validateMsg.textContent = error.message.includes('nicht gefunden')
            ? 'Pfad existiert nicht oder Datei wurde nicht gefunden.'
            : error.message;
          validateMsg.classList.remove('hidden');
          validateMsg.classList.add('inline-error');
          showToast('error', validateMsg.textContent);
        }
      });

      resetCacheButton.addEventListener('click', async () => {
        clearMessages();
        try {
          await resetCache();
          cacheMsg.textContent = 'Cache wurde zurückgesetzt.';
          cacheMsg.classList.remove('hidden');
          cacheMsg.classList.add('inline-ok');
          showToast('success', 'Cache zurückgesetzt');
        } catch (error) {
          cacheMsg.textContent = error.message;
          cacheMsg.classList.remove('hidden');
          cacheMsg.classList.add('inline-error');
          showToast('error', error.message);
        }
      });

      loadConfig()
        .then((config) => {
          mergeAndRender(config);
        })
        .catch((error) => {
          showToast('error', error.message);
        });
    </script>
  </body>
</html>



